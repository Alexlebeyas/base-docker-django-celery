<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Puppet Deployment</title>
    <style>
        body {
            background-color: #eee;
            font-family: "Arial", Helvetica, sans-serif;
            font-size: 18px;
            margin: auto;
            max-width: 700px;
        }

        .code {
            background-color: #e5e5e5;
            font-style: italic;
            margin: 10px;
            padding: 10px;
        }

        .author {
            margin-top: 30px;
        }

        li {
            margin-top: 5px;
        }
    </style>
</head>
<body>

<h1>Puppet Deployment</h1>
<p><i>To use deploy.py, you must have <strong>rsync</strong> installed.</i></p>
<ul>
    <li><a href="#how-works">How puppet works</a></li>
    <li><a href="#access">Access and security</a></li>
    <li><a href="#first-deploy">First deployment</a></li>
    <li><a href="#normal-deploy">Normal deployment</a></li>
    <li><a href="#connecting">Connecting to the server</a></li>
    <li><a href="#remote-management">Manual remote management</a></li>
    <li><a href="#file-struct">Remote file structure</a></li>
</ul>

<h2 id="how-works">How puppet works</h2>
<p class="code"><a href="https://puppetlabs.com/">https://puppetlabs.com/</a></p>
<p>
    Puppet is made of manifests that describe a specific environment to be installed and maintained.
    The current puppet configuration is called <strong>Masterless Puppet</strong>.
    Those manifests are copied to the remote server via rsync and are applied with the execution of
    <i>puppet/sh/prod.sh</i>. This is done with a python script called <strong>deploy.py</strong> in
    puppet directory.
</p>

<h2 id="access">Access and security</h2>
<p>
    Puppet will automatically restrict ssh access by disabling root & password login. You must put your
    public key in <i>puppet/modules/deploy/templates/authorized_keys.erb</i> or will be <strong>locked out</strong>.
    The only access to the server is with the deploy user and ssh keys.
</p>

<h2 id="first-deploy">First deployment</h2>
<ol type="1">
    <li>Create a droplet with your public ssh key as root access and retrieve the IP.</li>
    <li>Copy and rename puppet/modules/django/templates/pip.erb.template:
        <ul>
            <li>Name it pip.erb</li>
            <li>Add credentials to the file</li>
            <li>The username, the password and the host</li>
        </ul>
    </li>
    <li>Input the follow settings:
        <ul>
            <li>puppet/manifests/prod.pp =&gt; Set GIT repository URL</li>
            <li>puppet/deploy.py =&gt; Set the server IP</li>
            <li>puppet/connect.sh =&gt; Set the server IP</li>
            <li><i>(project_name)</i>/prod.py =&gt; Set the server IP to allowed hosts</li>
        </ul>
    </li>
    <li>
        From the puppet directory, execute install_puppet to install puppet and puppet modules on the remote server:
        <p class="code">&gt;&gt; python deploy.py install_puppet</p>
        This will also rsync all the puppet modules and manifests. At this point, many dependencies
        will fail because the remote server does not have access to the GIT.
    </li>
    <li>
        Retrieve the newly created public key for the project user:
        <p class="code">&gt;&gt; python deploy.py git_key</p>
        And add it to bitbucket in "deployment keys".
    </li>
    <li>You may be now proceed with the normal deployment</li>
</ol>

<h2 id="normal-deploy">Normal deployment</h2>
<p>The normal deployment flows like this:</p>
<p class="code">&gt;&gt; python deploy.py</p>
<p>
    Executing the deploy.py script with no arguments does the normal deployment.
    Those steps are done automatically:
</p>
<ol type="1">
    <li>Rsync puppet manifests</li>
    <li>Apply <i>puppet/sh/prod.sh</i></li>
    <li>Update all configs with puppet</li>
    <li>Pull GIT</li>
    <li>Collect static files</li>
    <li>Run migrations</li>
    <li>Restart uWSGI and celery with supervisor</li>
</ol>
<p style="color: red">Steps 5-6-7 are only executed if there was a commit to pull.</p>

<h2 id="connecting">Connecting to the server</h2>
<p>You can connect to a server with ssh as deploy user:</p>
<p class="code">&gt;&gt; ssh deploy@(prod-ip)</p>
<p>
    Or you can use a shell script that was configured in the "First deployment" section.
    It is a dot command that should be called from the puppet directory like so:
</p>
<p class="code">&gt;&gt; . puppet/connect.sh</p>
<p><i>Note: There is a space between the dot and the command.</i></p>

<h2 id="remote-management">Manual remote management</h2>
<p>
    Once you are connected as deploy, you can sudo without a password to do root server management.
    All project management should be done as project user.
</p>
<p class="code">&gt;&gt; sudo su (project_user)</p>
<p>
    As project user, change working directory to your home. Simply type "cd".
    From your home directory, you may activate the python virtualenv with a dot command:
</p>
<p class="code">&gt;&gt; . activate</p>
<p>From there you can execute any python-django commands.</p>
<p><i>Note: There is a space between the dot and the command.</i></p>

<h2 id="file-struct">Remote file structure</h2>
<pre class="code">
    # Directory that contains custom manifests
    # and modules copied with rsync.
    /etc/puppet/sync/

    # Project user home directory with project,
    # logs, deployment key and virtualenv.
    /home/(project_user)/
    /home/(project_user)/.ssh/
    /home/(project_user)/activate
    /home/(project_user)/logs/
    /home/(project_user)/venv/

    # The django project folder, cloned from GIT.
    /home/(project_user)/project/
</pre>

<p class="author">Author: Simon Lessnick</p>
</body>
</html>